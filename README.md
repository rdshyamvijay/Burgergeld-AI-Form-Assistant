# BÃ¼rgergeld AI Form Assistant (Laravel 12 + Gemini + PDFtk)

An interactive assistant that guides German BÃ¼rgergeld applicants through the **Hauptantrag (HA)** and **Anlage WEP** forms, fills any missing data, and delivers a **merged PDF** (HA + WEP) ready for download. The project combines deterministic PDF mapping with helpful AI moments backed by Google Gemini.

https://github.com/user-attachments/assets/23077001-f818-4a4b-a0aa-0d0b12059a03



---

## âœ¨ Key Features

### Guided Form Experience
- **Dynamic HA form renderer**: generated from `config/ha.php`, so fields stay in sync with the PDF.
- **Household annex planner**: toggling â€œanother adult in my BGâ€ feeds the annex selector and prepares WEP data.
- **WEP smart form**: only shows questions still missing for the target household member.

### AI Integrations


https://github.com/user-attachments/assets/2a53edff-4a52-4ac8-b888-8cc5e231371f


- **Annex selection** (`/api/ai/annexes`): Gemini recommends HA + WEP (demo scope) based on the current domain JSON. Deterministic guard rails ensure HA is always included.
- **â€œWhatâ€™s missing?â€ generator** (`/api/wep/questions`): Gemini receives metadata from `WEP_fields.txt` and returns natural questions; we fall back to deterministic logic if the call fails.
- **Field-level assistant**: every â€œ?â€ button opens a chat widget that:
  - explains the field (tooltip prompt),
  - lets users ask followâ€‘ups with conversation context,
  - remembers the active field so answers stay relevant.
- **Offline fallback**: whenever Gemini is unavailable, concise hints generated by `fallbackHelpText()` keep the flow usable.

### Deterministic PDF Filler
- Uses `mikehaertl/pdftk` + system `pdftk` to populate `storage/app/forms/BÃ¼rgergeld_Hauptantrag.pdf` and `storage/app/forms/WEP.pdf`.
- HA + WEP PDFs are merged server-side before download; filled checkboxes and radios use the exact FieldStateOption values discovered in the official templates.

---

## ğŸ§± Architecture Overview

```
citizen-form/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ Http/Controllers/
â”‚   â”‚   â”œâ”€â”€ AiController.php         # AI endpoints (annex planner, WEP questions, chat)
â”‚   â”‚   â””â”€â”€ CitizenFormPdfController.php  # HA + WEP fill + merge
â”‚   â””â”€â”€ Services/GeminiClient.php   # REST helper (text, JSON, and chat)
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ ai.php                      # Gemini configuration (model, endpoint, temperature)
â”‚   â”œâ”€â”€ ha.php                      # HA field schema (drives the UI)
â”‚   â”œâ”€â”€ wep.php                     # Required WEP keys + enum lists
â”‚   â””â”€â”€ annex.php                   # Deprecated safety copy of earlier rules (optional)
â”œâ”€â”€ resources/views/
â”‚   â”œâ”€â”€ layouts/app.blade.php       # Shared layout + floating chat widget
â”‚   â”œâ”€â”€ apply.blade.php             # HA form + household card
â”‚   â”œâ”€â”€ annexes.blade.php           # Annex summary pills
â”‚   â””â”€â”€ wep.blade.php               # Missing WEP fields form
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ web.php                     # UI routes
â”‚   â””â”€â”€ api.php                     # JSON + AI endpoints
â”œâ”€â”€ storage/app/forms/
â”‚   â”œâ”€â”€ BÃ¼rgergeld_Hauptantrag.pdf
â”‚   â””â”€â”€ WEP.pdf
â””â”€â”€ README.md
```

The conversation state and current domain are persisted to `storage/app/domain.json` (simple JSON file; no database required).

---

## ğŸ›  Requirements

| Component | Minimum | Notes |
|-----------|---------|-------|
| PHP       | 8.3+    | Required by Laravel 12 |
| Composer  | Latest  | Dependency management |
| Node/NPM  | optional| Only if you modify frontend assets manually |
| pdftk     | any     | `mikehaertl/pdftk` needs the CLI |
| Gemini API key | â€” | Set `GEMINI_API_KEY` in `.env`; fallback messages still work without it |

### Install PDFtk (macOS)
```bash
brew install pdftk-java
which pdftk   # typically /opt/homebrew/bin/pdftk
```
Update `PDFTK_CMD` in `.env` if your path differs.

---

## ğŸš€ Setup & Development

```bash
git clone https://github.com/<your-username>/pdf-mapping.git
cd pdf-mapping/citizen-form

composer install
cp .env.example .env
php artisan key:generate

# Provide AI + PDF settings
echo "GEMINI_API_KEY=your-key" >> .env
echo "PDFTK_CMD=/opt/homebrew/bin/pdftk" >> .env  # adjust if necessary

# Place the official templates
mkdir -p storage/app/forms
cp /path/to/BÃ¼rgergeld_Hauptantrag.pdf storage/app/forms/
cp /path/to/WEP.pdf storage/app/forms/

php artisan serve
# -> http://127.0.0.1:8000/apply
```

Every session overwrites `storage/app/domain.json` and resets WEP answers so you always fill fresh forms.

---

## ğŸ§­ User Flow

1. **Go to `/apply`**  
   - Fill applicant details; click â€œ?â€ anytime to see AI guidance.  
   - Toggle â€œI live with another adult in my BGâ€ to trigger WEP.

2. **Continue to `/annexes`**  
   - View AI-selected annexes (demo: HA + WEP).  
   - Continue to WEP or download HA-only if WEP is not needed.

3. **Answer WEP prompts `/wep`**  
   - Only missing fields appear; question marks open contextual chat.  
   - Submit to auto-save and redirect to the merged PDF download (`/merged`).

4. **Download merged PDF**  
   - The response includes HA + WEP pages; headers carry a base64 plan of included annexes for client inspection.

---

## ğŸ”Œ API Endpoints (JSON)

| Method | Endpoint            | Description |
|--------|---------------------|-------------|
| POST   | `/api/form/save`    | Save/merge HA + household data (resets old WEP answers) |
| POST   | `/api/ai/annexes`   | Gemini-backed annex plan + deterministic fallback |
| GET    | `/api/wep/questions`| Missing WEP fields for the primary household member |
| POST   | `/api/wep/save`     | Persist WEP answers |
| POST   | `/api/ai/help`      | Field tooltip explanation |
| POST   | `/api/ai/chat`      | Continues the conversation with context |
| GET    | `/api/ha-schema`    | HA schema (drives the frontend) |
| GET    | `/api/domain`       | Current domain JSON (for debugging) |

Legacy PDF API (`POST /api/citizen-form-pdf`) still exists for headless HA filling, but the recommended path is `/apply` â†’ `/merged`.

---

## ğŸ§  Prompt Engineering Cheatsheet

| Use Case            | Prompt Highlights |
|---------------------|-------------------|
| Annex planner       | â€œAlways include HAâ€¦ include WEP for 15+ BG membersâ€¦â€ + domain JSON |
| WEP question builder| List of `{key,label,type,options,current_value}` â†’ â€œReturn ONLY JSON {questions:â€¦}â€ |
| Field tooltip       | Field label/type/required/options â†’ â€œExplain in <= 2 sentencesâ€¦â€ |
| Chat assistant      | Conversation history + system prompt (stay on field, max 3 sentences, no personal data) |

Every critical step has deterministic fallbacks so the app remains usable if Gemini is unavailable.

---

## âœ… Testing Tips

```bash
# Fill HA + WEP with example data and download merged PDF
curl -sS "http://127.0.0.1:8000/api/form/save" \
  -X POST -H "Content-Type: application/json" \
  -d @test.json

curl -sS "http://127.0.0.1:8000/api/wep/questions"

curl -sS "http://127.0.0.1:8000/merged" --output Buergergeld_HA_WEP.pdf
```

Or stay in the UI: `php artisan serve` â†’ `http://127.0.0.1:8000/apply`.

---

## ğŸ“„ License & Credits

- **License:** MIT â€“ free to adapt for your own BÃ¼rgergeld automation experiments.
- **Built with:** Laravel 12, PHP 8.3, PDFtk, Google Gemini, Tailored prompt engineering.
- **Maintainer:** Shyamkumar Selvakumar

Questions or ideas? Open an issue or start a discussion on the repository. Viel Erfolg beim AusfÃ¼llen! ğŸ“
